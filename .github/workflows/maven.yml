name: MY AUTOTESTS BOLKUNOVA

permissions:
  id-token: write # Grant id-token: write permission
  pages: write
  contents: write

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Install Allure
        run: |
          curl -o allure.zip -L https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.zip  
          sudo apt-get install -y unzip  
          unzip allure.zip -d /opt/allure  
          sudo ln -s /opt/allure/allure-2.25.0/bin/allure /usr/bin/allure 

      - name: Build
        run: mvn clean install
      - name: Run tests with Allure
        run: |
          mvn clean test
          echo "=== Checking test results ==="
          find target/ -name "*.json" -o -name "*.xml" 2>/dev/null | head -10

      - name: List Allure Results Files
        run: |
          mkdir -p allure-results 
          ls -R allure-results

      - name: Generate Allure Report
        run: |
          mkdir -p allure-report  
          echo "=== Report generated at ==="
          allure generate --clean target/allure-results -o allure-report

      - name: List Allure Report Files Before Upload
        run: ls -R allure-report

      - name: Upload Allure Report as artifact
        uses: actions/upload-artifact@v4
        with:
          path: 'allure-report'
      - name: Prepare Test Results Summary
        id: test-results
        run: |
          # –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
          TOTAL_TESTS=$(find target/allure-results -name "*-result.json" | wc -l | tr -d ' ')
          PASSED_TESTS=$(grep -r '"status":"passed"' target/allure-results | wc -l | tr -d ' ')
          FAILED_TESTS=$(grep -r '"status":"failed"' target/allure-results | wc -l | tr -d ' ')
          BROKEN_TESTS=$(grep -r '"status":"broken"' target/allure-results | wc -l | tr -d ' ')
          
          echo "total=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "broken=$BROKEN_TESTS" >> $GITHUB_OUTPUT
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          if [ $FAILED_TESTS -gt 0 ] || [ $BROKEN_TESTS -gt 0 ]; then
          echo "status=FAILED" >> $GITHUB_OUTPUT
          echo "emoji=‚ùå" >> $GITHUB_OUTPUT
          else
          echo "status=PASSED" >> $GITHUB_OUTPUT
          echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ steps.test-results.outputs.emoji }} Test Results: ${{ steps.test-results.outputs.status }} - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}>
          body: |
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤:
            
            üìä –°—Ç–∞—Ç—É—Å: ${{ steps.test-results.outputs.status }} ${{ steps.test-results.outputs.emoji }}
            üìà –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${{ steps.test-results.outputs.total }}
            ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö: ${{ steps.test-results.outputs.passed }}
            ‚ùå –£–ø–∞–≤—à–∏—Ö: ${{ steps.test-results.outputs.failed }}
            ‚ö†Ô∏è –°–ª–æ–º–∞–Ω–Ω—ã—Ö: ${{ steps.test-results.outputs.broken }}
            
            üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            üè∑Ô∏è –ö–æ–º–º–∏—Ç: ${{ github.sha }}
            üéØ –í–µ—Ç–∫–∞: ${{ github.ref }}
            
            Allure –æ—Ç—á–µ—Ç –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è workflow.